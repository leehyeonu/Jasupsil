<!doctype html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>교실 소음·집중도 알리미 - 센서(dB)</title>
<style>
  :root { --bg:#0f172a; --card:#111827cc; --text:#e5e7eb; --muted:#94a3b8; }
  body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto; background:linear-gradient(135deg,#0f172a,#111827); color:var(--text); }
  header,footer { padding:12px 16px; background:#0b1220aa; backdrop-filter:blur(8px); }
  .wrap { min-height:calc(100vh - 110px); display:flex; align-items:center; justify-content:center; }
  .card { width:min(900px,96vw); background:var(--card); border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  select,button { height:42px; border-radius:10px; border:1px solid #1f2937; background:#0b1220; color:var(--text); padding:0 12px; }
  button.primary { background:#2563eb; border-color:#1d4ed8; }
  .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#0b1220; border:1px solid #1f2937; font-size:14px; color:var(--muted); }
  .led { height:40vh; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:clamp(24px,4vw,40px); font-weight:700; margin-top:12px; transition:background 200ms,color 200ms; }
  .hint { color:var(--muted); font-size:14px; margin-top:8px; }
  canvas { display:block; width:100%; margin-top:10px; border-radius:8px; background:#0b1220; border:1px solid #1f2937; }
</style>

<header class="row" style="justify-content:space-between;">
  <div class="row">
    <strong>교실 소음·집중도 알리미 · 센서(dB)</strong>
    <span class="pill">원음 미저장</span>
    <span class="pill">자습 전용</span>
  </div>
  <div class="row">
    <label>반</label>
    <select id="room">
      <option value="1">1반</option><option value="2">2반</option><option value="3">3반</option>
      <option value="4">4반</option><option value="5">5반</option><option value="6">6반</option>
      <option value="7">7반</option><option value="8">8반</option><option value="9">9반</option>
    </select>
    <button id="start" class="primary">시작</button>
    <button id="stop" disabled>중지</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div id="led" class="led" style="background:#0b1220; color:#93c5fd;">대기 중</div>
    <canvas id="spark" height="80"></canvas>
    <div class="row" style="margin-top:12px;">
      <div class="pill">dB: <span id="db">0.0</span></div>
      <div class="pill">상태: <span id="state">-</span></div>
      <div class="pill">업로드: <span id="sent">-</span></div>
    </div>
    <div class="hint">임계치(고정): 주의 55 dB · 시끄러움 65 dB. 원음은 저장/전송하지 않습니다.</div>
  </div>
</div>

<footer>마이크 안내: “원음 저장/전송 없음, 10초 평균 dB만 전송, 중지 시 즉시 종료”</footer>

<script type="module">
  // dB 전용 센서 스크립트(수정판): 조용한 공간 평균 20 dB, 최대 66 dB 가정
  // - 표시/업로드: dB(EMA 스무딩, 10초 평균)
  // - 자동 교정: 최초 5초 dbFS 중앙값을 20 dB에 맞춰 오프셋 저장(localStorage)
  // - 임계 고정: 주의 45 dB, 시끄러움 60 dB
  // - 업로드 경로: rooms/{1~9}/now  (필드: db, level, ts, online)

  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getDatabase, ref, set, remove } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  // Firebase 구성(현우님 프로젝트)
  const firebaseConfig = {
    apiKey: "AIzaSyDMRpooeNP3Jds7o-TglR9S50gAkObQE8A",
    authDomain: "jasupsil.firebaseapp.com",
    databaseURL: "https://jasupsil-default-rtdb.firebaseio.com",
    projectId: "jasupsil",
    messagingSenderId: "1042128694552",
    appId: "1:1042128694552:web:716099a644d957cd9e026d"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // dB 임계/스케일(고정)
  const CAUTION_DB = 45;   // 주의
  const NOISY_DB  = 60;   // 시끄러움
  const MIN_DB    = 20;   // 표시 하한(조용 기준)
  const MAX_DB    = 70;   // 표시 상한(최대 66 dB 고려)
  const TARGET_QUIET_DB = 20; // 자동 교정 목표(조용한 곳 평균 20 dB)

  // 자동 교정 오프셋: 저장값 사용, 없으면 5초간 측정해 산출
  let SPL_OFFSET = Number(localStorage.getItem("splOffset") ?? "NaN");

  // DOM 참조
  const roomSel = document.getElementById('room');
  const led     = document.getElementById('led');
  const dbEl    = document.getElementById('db');
  const stateEl = document.getElementById('state');
  const sentEl  = document.getElementById('sent');
  const spark   = document.getElementById('spark');
  const ctx     = spark.getContext('2d');
  const startBtn= document.getElementById('start');
  const stopBtn = document.getElementById('stop');

  // 상태
  let audioCtx=null, analyser=null, stream=null;
  let rafId=0, sampleTimer=0, uploadTimer=0;
  let dbEma=MIN_DB; const alpha=0.3;  // dB 표시는 EMA로 안정화

  // 실시간(100ms)·업로드(10초)
  const SPARK_MS=100, MAX_SAMPLES=600; const samples=[];
  const UPLOAD_MS=10000; const agg=[];

  const clamp=(v,a,b)=>Math.min(b,Math.max(a,v));
  const scale01=(v)=>clamp((v - MIN_DB)/(MAX_DB - MIN_DB), 0, 1);
  const levelOf=(d)=> d>=NOISY_DB ? '시끄러움' : (d>=CAUTION_DB ? '주의' : '정상');

  function setLED(level, d){
    let bg='#0b1220', fg='#93c5fd';
    if (level==='정상'){ bg='linear-gradient(135deg,#052e16,#14532d)'; fg='#d1fae5'; }
    if (level==='주의'){ bg='linear-gradient(135deg,#3b2f0b,#92400e)'; fg='#fff7ed'; }
    if (level==='시끄러움'){ bg='linear-gradient(135deg,#450a0a,#7f1d1d)'; fg='#fee2e2'; }
    led.style.background=bg; led.style.color=fg; led.textContent=level;
    dbEl.textContent=d.toFixed(1);
    stateEl.textContent=level;
  }

  function drawSpark(){
    const w=spark.clientWidth, h=spark.height;
    if (spark.width!==w) spark.width=w;
    ctx.clearRect(0,0,w,h);
    ctx.strokeStyle='#1f2937'; ctx.lineWidth=1;
    // 가이드 라인
    ctx.beginPath(); ctx.moveTo(0,h*0.4); ctx.lineTo(w,h*0.4); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(0,h*0.6); ctx.lineTo(w,h*0.6); ctx.stroke();
    if (samples.length<2) return;
    ctx.strokeStyle='#60a5fa'; ctx.lineWidth=2; ctx.beginPath();
    for (let i=0;i<samples.length;i++){
      const x=i*(w/(MAX_SAMPLES-1));
      const y=h - Math.min(h, Math.max(0, samples[i]*h)); // 0~1 → 0~h
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
  }

  function loop(){
    const buf=new Uint8Array(analyser.fftSize);
    analyser.getByteTimeDomainData(buf);
    let sum=0; for(let i=0;i<buf.length;i++){ const v=(buf[i]-128)/128; sum+=v*v; }
    const rms = Math.sqrt(sum/buf.length);
    const dbfs = 20 * Math.log10(rms + 1e-8);          // 상대 dB
    const offset = Number.isNaN(SPL_OFFSET) ? 0 : SPL_OFFSET;
    const dB = dbfs + offset;                           // 보정 적용
    dbEma = alpha*dB + (1-alpha)*dbEma;                 // EMA 스무딩
    const dBview = clamp(dbEma, MIN_DB, MAX_DB);        // 표시 범위 클램프
    setLED(levelOf(dBview), dBview);
    rafId=requestAnimationFrame(loop);
  }

  function startSampling(){
    // 100ms: 그래프·집계 버퍼
    sampleTimer=setInterval(()=>{
      samples.push(scale01(clamp(dbEma, MIN_DB, MAX_DB)));
      if (samples.length>MAX_SAMPLES) samples.shift();
      agg.push(dbEma);
      drawSpark();
    }, SPARK_MS);

    // 10초: 평균 dB 업로드
    uploadTimer=setInterval(async ()=>{
      if (!agg.length) return;
      const avg = agg.reduce((a,b)=>a+b,0)/agg.length; agg.length=0;
      const now = Date.now(); const room=roomSel.value;
      const payload = { db:+avg.toFixed(1), level:levelOf(avg), ts:now, online:true };
      try{ await set(ref(db, `rooms/${room}/now`), payload); sentEl.textContent=new Date(now).toLocaleTimeString(); }
      catch(e){ console.error(e); }
    }, UPLOAD_MS);
  }

  function stopAll(){
    cancelAnimationFrame(rafId); rafId=0;
    clearInterval(sampleTimer); sampleTimer=0;
    clearInterval(uploadTimer); uploadTimer=0;
    try{ stream?.getTracks().forEach(t=>t.stop()); }catch{}
    stream=null;
    if (audioCtx){
      if (audioCtx.state==='suspended'){ try{ audioCtx.resume(); }catch{} }
      try{ audioCtx.close(); }catch{}
      audioCtx=null; analyser=null;
    }
  }

  async function markOffline(){
    const room=roomSel.value;
    try{ await remove(ref(db, `rooms/${room}/now`)); }catch(e){ console.error(e); }
  }

  // 최초 5초 자동 교정: 조용한 상태에서 중앙값을 20 dB로 맞춤
  function autoCalibrate(){
    if (!Number.isNaN(SPL_OFFSET)){
      return; // 이미 보정값 있음
    }
    const cal=[]; let count=0;
    const t = setInterval(()=>{
      if (!analyser) return;
      const buf=new Uint8Array(analyser.fftSize);
      analyser.getByteTimeDomainData(buf);
      let sum=0; for(let i=0;i<buf.length;i++){ const v=(buf[i]-128)/128; sum+=v*v; }
      const rms = Math.sqrt(sum/buf.length);
      const dbfs = 20 * Math.log10(rms + 1e-8);
      cal.push(dbfs); count++;
      if (count>=50){ // 약 5초(100ms*50)
        clearInterval(t);
        cal.sort((a,b)=>a-b);
        const median = cal[Math.floor(cal.length/2)];
        SPL_OFFSET = TARGET_QUIET_DB - median;
        localStorage.setItem('splOffset', SPL_OFFSET.toFixed(1));
        // 즉시 반영을 위해 EMA도 살짝 당겨줌
        dbEma = TARGET_QUIET_DB;
      }
    }, 100);
  }

  async function start(){
    try{
      stream = await navigator.mediaDevices.getUserMedia({
        audio:{ echoCancellation:true, noiseSuppression:true }, video:false
      });
      audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const source=audioCtx.createMediaStreamSource(stream);
      analyser=audioCtx.createAnalyser(); analyser.fftSize=1024; source.connect(analyser);
      if (audioCtx.state!=='running'){ try{ await audioCtx.resume(); }catch{} }
      // 자동 교정 시작(보정 없을 때만)
      autoCalibrate();
      // 측정·업로드 루프 시작
      loop(); startSampling();
      startBtn.disabled=true; stopBtn.disabled=false;
    }catch(err){
      let msg='마이크 사용을 시작할 수 없습니다. ';
      if (err?.name==='NotAllowedError') msg+='사이트의 마이크 권한을 허용해 주세요.';
      else if (err?.name==='SecurityError') msg+='HTTPS로 접속했는지 확인해 주세요.';
      else if (err?.name==='NotReadableError') msg+='다른 앱이 마이크를 사용 중일 수 있습니다.';
      else if (err?.name==='NotFoundError') msg+='마이크 장치가 없거나 비활성화되었습니다.';
      alert(msg); console.error(err);
      await markOffline(); stopAll();
    }
  }

  async function stop(){
    await markOffline(); stopAll();
    led.style.background='#0b1220'; led.style.color='#93c5fd'; led.textContent='종료';
    dbEl.textContent='0.0'; stateEl.textContent='-'; sentEl.textContent='-';
    samples.length=0; agg.length=0; drawSpark();
    startBtn.disabled=false; stopBtn.disabled=true;
  }

  // 백그라운드 이동 시 자동 중지(유령 온라인 방지)
  document.addEventListener('visibilitychange', async ()=>{
    if (document.hidden && stopBtn.disabled===false){ await stop(); }
  });

  startBtn.onclick=start; stopBtn.onclick=stop;
</script>
