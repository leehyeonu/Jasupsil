<!doctype html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>교실 소음·집중도 알리미 - 대시보드(dB)</title>
<style>
  :root { --bg:#0f172a; --card:#111827cc; --text:#e5e7eb; --muted:#94a3b8; }
  body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto; background:radial-gradient(1200px 800px at 20% 10%, #0b1220, #0f172a); color:var(--text); }
  header { padding:14px 18px; display:flex; justify-content:space-between; align-items:center; background:#0b1220aa; backdrop-filter:blur(8px); }
  .grid { padding:18px; display:grid; grid-template-columns:repeat(3,1fr); gap:16px; }
  .card { background:var(--card); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); display:flex; flex-direction:column; gap:8px; }
  .title { display:flex; justify-content:space-between; align-items:center; }
  .badge { font-size:12px; color:#0b1220; padding:4px 8px; border-radius:999px; font-weight:700; }
  .state { font-size:clamp(22px,3.2vw,34px); font-weight:800; }
  .meta { color:var(--muted); font-size:14px; display:flex; gap:12px; flex-wrap:wrap; }
  .bar { height:10px; width:100%; background:#0b1220; border-radius:999px; overflow:hidden; border:1px solid #1f2937; }
  .fill { height:100%; width:0%; background:linear-gradient(90deg,#22c55e,#f59e0b,#ef4444); transition:width 200ms; }
  @media (max-width:860px){ .grid{ grid-template-columns:1fr; } }
</style>

<header>
  <strong>교실 소음·집중도 알리미 · 대시보드(dB)</strong>
  <span style="color:var(--muted); font-size:14px;">실시간 · 9개 반</span>
</header>
<div class="grid" id="grid"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDMRpooeNP3Jds7o-TglR9S50gAkObQE8A",
    authDomain: "jasupsil.firebaseapp.com",
    databaseURL: "https://jasupsil-default-rtdb.firebaseio.com",
    projectId: "jasupsil",
    messagingSenderId: "1042128694552",
    appId: "1:1042128694552:web:716099a644d957cd9e026d"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const rooms = Array.from({length:9}, (_,i)=> String(i+1));
  const grid = document.getElementById('grid');

  const MIN_DB=30, MAX_DB=80;
  const scale=(v)=>Math.min(100, Math.max(0, Math.round((v - MIN_DB)/(MAX_DB - MIN_DB)*100)));

  const cardTemplate = r => `
    <div class="card" id="card-${r}">
      <div class="title">
        <div><strong>${r}반</strong></div>
        <div id="badge-${r}" class="badge" style="background:#cbd5e1;">OFFLINE</div>
      </div>
      <div id="state-${r}" class="state">-</div>
      <div class="bar"><div id="fill-${r}" class="fill"></div></div>
      <div class="meta">
        <span>dB: <span id="db-${r}">0.0</span></span>
        <span>업데이트: <span id="age-${r}">-</span></span>
        <span>모드: <span id="mode-${r}">selfstudy</span></span>
      </div>
    </div>`;
  grid.innerHTML = rooms.map(cardTemplate).join('');

  function setCard(r, snapshotValue){
    const data = snapshotValue?.[r];
    const stateEl = document.getElementById('state-'+r);
    const dbEl = document.getElementById('db-'+r);
    const ageEl = document.getElementById('age-'+r);
    const fillEl = document.getElementById('fill-'+r);
    const badge = document.getElementById('badge-'+r);
    const modeEl = document.getElementById('mode-'+r);

    if (!data || !data.now){
      stateEl.textContent='오프라인';
      dbEl.textContent='0.0';
      ageEl.textContent='-';
      fillEl.style.width='0%';
      badge.textContent='OFFLINE'; badge.style.background='#cbd5e1';
      modeEl.textContent='selfstudy';
      return;
    }
    const { db=0, level='-', ts=0 } = data.now;
    const ageSec = ts ? Math.floor((Date.now()-ts)/1000) : null;
    const online = ts && ageSec<=15;

    let bg='#cbd5e1', label='OFFLINE';
    if (online){
      if (level==='정상'){ bg='#86efac'; label='GREEN'; }
      else if (level==='주의'){ bg='#fde68a'; label='YELLOW'; }
      else if (level==='시끄러움'){ bg='#fca5a5'; label='RED'; }
    }
    badge.textContent=label; badge.style.background=bg;

    stateEl.textContent = online ? level : '오프라인';
    dbEl.textContent = Number(db).toFixed(1);
    ageEl.textContent = ts ? (online ? `${ageSec}s 전` : `${ageSec}s 지남`) : '-';
    fillEl.style.width = scale(Number(db)) + '%';
  }

  onValue(ref(db, 'rooms'), (snap)=>{
    const val = snap.val() || {};
    rooms.forEach(r => setCard(r, val));
  });
</script>
